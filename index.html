<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marble Economy</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Navigation */
        .nav-bar {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nav-tab {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .nav-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.4);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
        }

        /* Content Sections */
        .content-section {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Kids View */
        .kids-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 30px;
            margin-top: 20px;
        }

        .kid-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .kid-name {
            font-size: 24px;
            font-weight: bold;
            color: #4ecdc4;
            margin-bottom: 15px;
        }

        .marble-jar-container {
            position: relative;
            margin: 20px auto;
            width: 280px;
            height: 350px;
        }

        .marble-jar {
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.3) 100%);
            border: 4px solid #4ecdc4;
            border-radius: 15px 15px 25px 25px;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .marble {
            position: absolute;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3), inset -2px -2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .marble-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }

        .stat-box {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 12px;
            border-radius: 12px;
            font-weight: bold;
        }

        .stat-box.active { background: linear-gradient(135deg, #4ecdc4, #44a08d); }
        .stat-box.bank { background: linear-gradient(135deg, #ffd700, #ff8c00); }
        .stat-box.total { background: linear-gradient(135deg, #667eea, #764ba2); }

        .goal-section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 12px;
            border: 2px solid #ffd700;
        }

        .goal-name {
            font-weight: bold;
            color: #ff8c00;
            margin-bottom: 8px;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            overflow: hidden;
            margin: 8px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffd700, #ff8c00);
            border-radius: 10px;
            transition: width 0.5s ease;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .bank-controls {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }

        .bank-controls input {
            flex: 1;
            padding: 10px;
            border: 2px solid #4ecdc4;
            border-radius: 8px;
            font-size: 16px;
        }

        .btn {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.4);
        }

        .btn.danger {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        }

        .btn.success {
            background: linear-gradient(135deg, #2ed573, #1e90ff);
        }

        /* Parent Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .dashboard-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            font-size: 18px;
            font-weight: bold;
            color: #4ecdc4;
            margin-bottom: 15px;
            border-bottom: 2px solid #4ecdc4;
            padding-bottom: 8px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #4ecdc4;
        }

        /* Chores */
        .chore-category {
            margin-bottom: 25px;
        }

        .category-title {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .chore-list {
            display: grid;
            gap: 10px;
        }

        .chore-item {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #4ecdc4;
        }

        .chore-info {
            flex: 1;
        }

        .chore-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .chore-value {
            color: #4ecdc4;
            font-weight: bold;
        }

        .award-btn {
            background: linear-gradient(135deg, #2ed573, #1e90ff);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        /* Rewards */
        .rewards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .reward-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .reward-card:hover {
            border-color: #4ecdc4;
            transform: translateY(-5px);
        }

        .reward-cost {
            background: linear-gradient(135deg, #ffd700, #ff8c00);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 10px;
        }

        .reward-name {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        /* Confetti Animation */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #ff6b6b;
            animation: confetti-fall 3s linear forwards;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        .toast.error {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        }

        .toast.info {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .nav-tabs {
                justify-content: center;
            }

            .kids-grid {
                grid-template-columns: 1fr;
            }

            .marble-jar-container {
                width: 240px;
                height: 300px;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .bank-controls {
                flex-direction: column;
            }
        }

        /* Rules Section */
        .rules-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .rules-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .rules-content.open {
            max-height: 500px;
        }

        .rules-toggle {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            margin-bottom: 15px;
        }

        /* History Table */
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .history-table th,
        .history-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .history-table th {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
            font-weight: 600;
        }

        .history-table tr:hover {
            background: rgba(78, 205, 196, 0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Navigation -->
        <div class="nav-bar">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchTab('kids')">Kids View</button>
                <button class="nav-tab" onclick="switchTab('parent')">Parent Dashboard</button>
                <button class="nav-tab" onclick="switchTab('chores')">Chores</button>
                <button class="nav-tab" onclick="switchTab('rewards')">Rewards</button>
                <button class="nav-tab" onclick="switchTab('history')">History</button>
            </div>
        </div>

        <!-- Rules Panel -->
        <div class="rules-panel">
            <button class="rules-toggle" onclick="toggleRules()">📜 House Rules & Guidelines</button>
            <div class="rules-content" id="rulesContent">
                <h3>🏠 Family Marble Economy Rules</h3>
                <p><strong>Banking:</strong> Marbles roll over to next week. Save marbles in your bank to work toward goals!</p>
                <p><strong>Screen Time:</strong> 1 hour M-F, 3 hours Sat-Sun. Complete all daily chores for half-price screen time!</p>
                <p><strong>Devices Off:</strong> 8:30pm weekdays, 10:00pm weekends</p>
                <p><strong>Respect:</strong> Feelings are always okay. Only disrespect costs marbles.</p>
                <p><strong>Cash Out:</strong> Optional weekend: 20 marbles = $1 (max $5/week)</p>
                <p><strong>No Buying:</strong> Marbles cannot be purchased with money</p>
            </div>
        </div>

        <!-- Kids View -->
        <div id="kids" class="content-section active">
            <div class="kids-grid" id="kidsGrid">
                <!-- Kids will be populated here -->
            </div>
        </div>

        <!-- Parent Dashboard -->
        <div id="parent" class="content-section">
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <h3 class="card-title">👥 Manage Kids</h3>
                    <div class="form-group">
                        <label>Kid Name</label>
                        <input type="text" id="kidName" placeholder="Enter kid's name">
                    </div>
                    <div class="form-group">
                        <label>Goal Name</label>
                        <input type="text" id="goalLabel" placeholder="e.g., Camp Champions">
                    </div>
                    <div class="form-group">
                        <label>Goal Target (marbles)</label>
                        <input type="number" id="goalTarget" placeholder="120">
                    </div>
                    <button class="btn" onclick="addKid()">Add Kid</button>
                    <div id="kidsList" style="margin-top: 15px;"></div>
                </div>

                <div class="dashboard-card">
                    <h3 class="card-title">🎯 Marble Management</h3>
                    <div class="form-group">
                        <label>Select Kid</label>
                        <select id="marbleKidSelect">
                            <option value="">Choose a kid...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" id="marbleAmount" placeholder="Number of marbles">
                    </div>
                    <div class="form-group">
                        <label>Reason</label>
                        <input type="text" id="marbleReason" placeholder="Why adding/removing marbles">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn success" onclick="addMarbles()">Add Marbles</button>
                        <button class="btn danger" onclick="removeMarbles()">Remove Marbles</button>
                    </div>
                </div>

                <div class="dashboard-card">
                    <h3 class="card-title">🏦 Bank Controls</h3>
                    <div class="form-group">
                        <label>Select Kid</label>
                        <select id="bankKidSelect">
                            <option value="">Choose a kid...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" id="bankAmount" placeholder="Number of marbles">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn" onclick="saveToBank()">Save to Bank</button>
                        <button class="btn" onclick="withdrawFromBank()">Withdraw from Bank</button>
                    </div>
                </div>

                <div class="dashboard-card">
                    <h3 class="card-title">📊 Family Stats</h3>
                    <div id="familyStats">
                        <!-- Stats will be populated here -->
                    </div>
                </div>

                <div class="dashboard-card">
                    <h3 class="card-title">🏆 Completed Goals</h3>
                    <div id="completedGoals">
                        <!-- Completed goals will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Chores -->
        <div id="chores" class="content-section">
            <div id="choresContainer">
                <!-- Chores will be populated here -->
            </div>
        </div>

        <!-- Rewards -->
        <div id="rewards" class="content-section">
            <div class="dashboard-card" style="margin-bottom: 20px;">
                <h3 class="card-title">🎁 Add New Reward</h3>
                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 15px; align-items: end;">
                    <div class="form-group">
                        <label>Reward Name</label>
                        <input type="text" id="newRewardName" placeholder="e.g., Extra Playdate">
                    </div>
                    <div class="form-group">
                        <label>Cost (marbles)</label>
                        <input type="number" id="newRewardCost" placeholder="25">
                    </div>
                    <button class="btn" onclick="addReward()">Add Reward</button>
                </div>
            </div>
            <div class="rewards-grid" id="rewardsGrid">
                <!-- Rewards will be populated here -->
            </div>
        </div>

        <!-- History -->
        <div id="history" class="content-section">
            <div class="dashboard-card">
                <h3 class="card-title">📈 Transaction History</h3>
                <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Filter by Kid</label>
                        <select id="historyKidFilter">
                            <option value="">All Kids</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Filter by Type</label>
                        <select id="historyTypeFilter">
                            <option value="">All Types</option>
                            <option value="add">Add Marbles</option>
                            <option value="remove">Remove Marbles</option>
                            <option value="save">Save to Bank</option>
                            <option value="withdraw">Withdraw from Bank</option>
                            <option value="purchase">Purchase</option>
                        </select>
                    </div>
                    <button class="btn" onclick="exportHistory()" style="align-self: end;">Export CSV</button>
                </div>
                <div id="historyContainer">
                    <!-- History will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Confetti Container -->
    <div class="confetti-container" id="confettiContainer"></div>

    <script>
        // GitHub Storage Integration
        class GitHubStorage {
            constructor(token, owner, repo) {
                this.token = token;
                this.owner = owner;
                this.repo = repo;
                this.apiBase = 'https://api.github.com';
                this.dataFile = 'marble-data.json';
            }

            async saveToGitHub(data) {
                try {
                    const currentFile = await this.getCurrentFile();
                    const content = btoa(JSON.stringify(data, null, 2));
                    
                    const body = {
                        message: `Update marble data - ${new Date().toISOString()}`,
                        content: content,
                        branch: 'main'
                    };

                    if (currentFile && currentFile.sha) {
                        body.sha = currentFile.sha;
                    }

                    const response = await fetch(
                        `${this.apiBase}/repos/${this.owner}/${this.repo}/contents/${this.dataFile}`,
                        {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${this.token}`,
                                'Accept': 'application/vnd.github.v3+json',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(body)
                        }
                    );

                    if (!response.ok) {
                        throw new Error(`GitHub API error: ${response.status}`);
                    }

                    return await response.json();
                } catch (error) {
                    console.error('Error saving to GitHub:', error);
                    throw error;
                }
            }

            async loadFromGitHub() {
                try {
                    const response = await fetch(
                        `${this.apiBase}/repos/${this.owner}/${this.repo}/contents/${this.dataFile}`,
                        {
                            headers: {
                                'Authorization': `Bearer ${this.token}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        }
                    );

                    if (response.status === 404) {
                        return null;
                    }

                    if (!response.ok) {
                        throw new Error(`GitHub API error: ${response.status}`);
                    }

                    const fileData = await response.json();
                    const content = atob(fileData.content);
                    return JSON.parse(content);
                } catch (error) {
                    console.error('Error loading from GitHub:', error);
                    throw error;
                }
            }

            async getCurrentFile() {
                try {
                    const response = await fetch(
                        `${this.apiBase}/repos/${this.owner}/${this.repo}/contents/${this.dataFile}`,
                        {
                            headers: {
                                'Authorization': `Bearer ${this.token}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        }
                    );

                    if (response.status === 404) {
                        return null;
                    }

                    return await response.json();
                } catch (error) {
                    return null;
                }
            }
        }

        // Data Management
        let kids = [];
        let chores = [];
        let rewards = [];
        let transactions = [];
        let gitHubStorage;
        let syncEnabled = false;

        // Initialize GitHub storage
        function initializeGitHubSync(token) {
            gitHubStorage = new GitHubStorage(token, 'healthquestceo', 'marble_economy');
            syncEnabled = true;
            loadFromGitHub();
        }

        // Enhanced save function
        async function saveData() {
            const data = {
                kids: kids,
                chores: chores,
                rewards: rewards,
                transactions: transactions,
                lastUpdated: new Date().toISOString()
            };

            // Save locally first (for offline access)
            localStorage.setItem('marbleKids', JSON.stringify(kids));
            localStorage.setItem('marbleChores', JSON.stringify(chores));
            localStorage.setItem('marbleRewards', JSON.stringify(rewards));
            localStorage.setItem('marbleTransactions', JSON.stringify(transactions));

            // Save to GitHub if enabled
            if (syncEnabled && gitHubStorage) {
                try {
                    await gitHubStorage.saveToGitHub(data);
                    updateSyncIndicator('success');
                } catch (error) {
                    updateSyncIndicator('error');
                    console.error('GitHub sync error:', error);
                }
            }
        }

        // Enhanced load function
        async function loadFromGitHub() {
            if (!syncEnabled || !gitHubStorage) {
                return;
            }

            try {
                updateSyncIndicator('loading');
                const data = await gitHubStorage.loadFromGitHub();
                
                if (data) {
                    kids = data.kids || [];
                    chores = data.chores || getDefaultChores();
                    rewards = data.rewards || getDefaultRewards();
                    transactions = data.transactions || [];
                    
                    // Migrate data if needed
                    kids.forEach(kid => {
                        if (kid.bankMarbles === undefined) kid.bankMarbles = 0;
                        if (!kid.goalLabel) kid.goalLabel = "My Goal";
                        if (!kid.goalTarget) kid.goalTarget = 100;
                        if (!kid.completedGoals) kid.completedGoals = [];
                    });

                    // Update UI
                    renderKidsView();
                    renderParentDashboard();
                    renderChores();
                    renderRewards();
                    renderHistory();
                    
                    updateSyncIndicator('success');
                } else {
                    updateSyncIndicator('no-data');
                }
            } catch (error) {
                updateSyncIndicator('error');
                console.error('GitHub load error:', error);
            }
        }

        // UI indicator functions
        function updateSyncIndicator(status) {
            const indicator = document.getElementById('syncIndicator');
            if (!indicator) return;
            
            switch(status) {
                case 'success':
                    indicator.textContent = '🌐 GitHub Sync: Connected';
                    indicator.style.background = 'linear-gradient(135deg, #4ecdc4, #44a08d)';
                    break;
                case 'error':
                    indicator.textContent = '⚠️ GitHub Sync: Error';
                    indicator.style.background = 'linear-gradient(135deg, #ff6b6b, #ee5a24)';
                    break;
                case 'loading':
                    indicator.textContent = '🔄 GitHub Sync: Loading...';
                    indicator.style.background = 'linear-gradient(135deg, #f39c12, #e67e22)';
                    break;
                case 'no-data':
                    indicator.textContent = '🌐 GitHub Sync: No Data Found';
                    indicator.style.background = 'linear-gradient(135deg, #95a5a6, #7f8c8d)';
                    break;
            }
        }

        function addSyncIndicator() {
            const navBar = document.querySelector('.nav-bar');
            const syncIndicator = document.createElement('div');
            syncIndicator.id = 'syncIndicator';
            syncIndicator.style.cssText = `
                margin-top: 10px;
                padding: 8px 12px;
                border-radius: 20px;
                font-size: 12px;
                text-align: center;
                font-weight: 600;
                color: white;
            `;
            
            if (syncEnabled) {
                syncIndicator.textContent = '🌐 GitHub Sync: Enabled';
                syncIndicator.style.background = 'linear-gradient(135deg, #4ecdc4, #44a08d)';
            } else {
                syncIndicator.textContent = '💾 Local Storage Only';
                syncIndicator.style.background = '#f39c12';
            }
            
            navBar.appendChild(syncIndicator);
        }

        function addManualSyncButton() {
            const syncButton = document.createElement('button');
            syncButton.textContent = '🔄 Sync';
            syncButton.className = 'btn';
            syncButton.style.cssText = 'position: fixed; bottom: 20px; right: 20px; z-index: 1000; font-size: 12px; padding: 8px 16px;';
            syncButton.onclick = async () => {
                if (syncEnabled) {
                    await saveData();
                } else {
                    showToast('GitHub sync not enabled', 'error');
                }
            };
            
            document.body.appendChild(syncButton);
        }

        // Initialize default data
        function initializeData() {
            // Load from localStorage or set defaults
            kids = JSON.parse(localStorage.getItem('marbleKids')) || [];
            chores = JSON.parse(localStorage.getItem('marbleChores')) || getDefaultChores();
            rewards = JSON.parse(localStorage.getItem('marbleRewards')) || getDefaultRewards();
            transactions = JSON.parse(localStorage.getItem('marbleTransactions')) || [];

            // Migrate existing kids to have bank and completed goals if they don't
            kids.forEach(kid => {
                if (kid.bankMarbles === undefined) kid.bankMarbles = 0;
                if (!kid.goalLabel) kid.goalLabel = "My Goal";
                if (!kid.goalTarget) kid.goalTarget = 100;
                if (!kid.completedGoals) kid.completedGoals = [];
            });

            saveData();
        }

        function getDefaultChores() {
            return [
                // Morning
                { id: 'morning-1', name: '🛏 Make bed', category: 'Morning', marbleValue: 1, dailyMax: null },
                { id: 'morning-2', name: '🪥 Brush teeth', category: 'Morning', marbleValue: 1, dailyMax: null },
                { id: 'morning-3', name: '🎒 Get ready (clothes, shoes, backpack)', category: 'Morning', marbleValue: 1, dailyMax: null },
                { id: 'morning-4', name: '🐶 Feed dogs', category: 'Morning', marbleValue: 1, dailyMax: null },
                
                // After School
                { id: 'after-1', name: '🎒 Put away backpack/lunchbox', category: 'After School', marbleValue: 1, dailyMax: null },
                { id: 'after-2', name: '📚 Homework', category: 'After School', marbleValue: 2, dailyMax: null },
                { id: 'after-3', name: '✏️ Read/Write/Draw (15 min)', category: 'After School', marbleValue: 1, dailyMax: 2 },
                { id: 'after-4', name: '🔬 Math/Science/Coding (15 min)', category: 'After School', marbleValue: 1, dailyMax: 2 },
                
                // Evening
                { id: 'evening-1', name: '🐾 Walk dogs', category: 'Evening', marbleValue: 2, dailyMax: null },
                { id: 'evening-2', name: '🐶 Feed dogs', category: 'Evening', marbleValue: 1, dailyMax: null },
                { id: 'evening-3', name: '🏀 Sports/Conditioning (15 min)', category: 'Evening', marbleValue: 1, dailyMax: 6 },
                { id: 'evening-4', name: '🍽 Load/Unload dishwasher', category: 'Evening', marbleValue: 2, dailyMax: null },
                { id: 'evening-5', name: '🍴 Set/Clear table', category: 'Evening', marbleValue: 1, dailyMax: null },
                { id: 'evening-6', name: '🧹 Quick room tidy', category: 'Evening', marbleValue: 1, dailyMax: null },
                { id: 'evening-7', name: '🚿 Shower + brush hair', category: 'Evening', marbleValue: 2, dailyMax: null },
                { id: 'evening-8', name: '🪥 Brush teeth', category: 'Evening', marbleValue: 1, dailyMax: null },
                
                // Weekend Jobs
                { id: 'weekend-1', name: '🐾 Walk dogs AM', category: 'Weekend', marbleValue: 2, dailyMax: null },
                { id: 'weekend-2', name: '🐾 Walk dogs PM', category: 'Weekend', marbleValue: 2, dailyMax: null },
                { id: 'weekend-3', name: '👕 Laundry', category: 'Weekend', marbleValue: 3, dailyMax: null },
                { id: 'weekend-4', name: '💩 Pick up poop', category: 'Weekend', marbleValue: 3, dailyMax: null },
                { id: 'weekend-5', name: '🏊 Clean pool', category: 'Weekend', marbleValue: 4, dailyMax: null },
                { id: 'weekend-6', name: '🛁 Clean bathrooms', category: 'Weekend', marbleValue: 4, dailyMax: null },
                { id: 'weekend-7', name: '👕 Bedroom/Closet', category: 'Weekend', marbleValue: 4, dailyMax: null },
                
                // Extra Grab-Bag Jobs
                { id: 'extra-1', name: '🗑 Trash gather/out', category: 'Extra', marbleValue: 1, dailyMax: null },
                { id: 'extra-2', name: '🧽 Wipe counters', category: 'Extra', marbleValue: 1, dailyMax: null },
                { id: 'extra-3', name: '🧸 Clean playroom', category: 'Extra', marbleValue: 1, dailyMax: null },
                { id: 'extra-4', name: '👩‍🍳 Help dinner', category: 'Extra', marbleValue: 2, dailyMax: null },
                { id: 'extra-5', name: '🧹 Vacuum House', category: 'Extra', marbleValue: 3, dailyMax: null },
                { id: 'extra-6', name: '🧽 Mop', category: 'Extra', marbleValue: 4, dailyMax: null }
            ];
        }

        function getDefaultRewards() {
            return [
                { id: 'screen-15', name: '📱 15 min Screen Time', cost: 5, notes: 'M-F' },
                { id: 'screen-30', name: '📱 30 min Screen Time', cost: 10, notes: 'M-F' },
                { id: 'screen-45', name: '📱 45 min Screen Time', cost: 15, notes: 'M-F' },
                { id: 'screen-60', name: '📱 60 min Screen Time', cost: 20, notes: 'M-F' },
                { id: 'screen-120', name: '📱 120 min Screen Time', cost: 40, notes: 'Weekend' },
                { id: 'screen-180', name: '📱 180 min Screen Time', cost: 60, notes: 'Weekend' },
                { id: 'playdate', name: '🎉 Playdate with friends', cost: 50, notes: 'Regular' },
                { id: 'playdate-wed', name: '🎉 Wednesday Playdate', cost: 25, notes: 'Half-price' },
                { id: 'weekend-activity', name: '🛝 Choose weekend activity', cost: 75, notes: 'Sleepover, bowling, etc' },
                { id: 'cash-5', name: '💵 $5 cash', cost: 100, notes: 'Max per week' }
            ];
        }

        // Navigation
        function switchTab(tabName) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active from all tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected section and activate tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Refresh content based on tab
            switch(tabName) {
                case 'kids':
                    renderKidsView();
                    break;
                case 'parent':
                    renderParentDashboard();
                    break;
                case 'chores':
                    renderChores();
                    break;
                case 'rewards':
                    renderRewards();
                    break;
                case 'history':
                    renderHistory();
                    break;
            }
        }

        // Kids Management
        function addKid() {
            const name = document.getElementById('kidName').value.trim();
            const goalLabel = document.getElementById('goalLabel').value.trim() || 'My Goal';
            const goalTarget = parseInt(document.getElementById('goalTarget').value) || 100;
            
            if (!name) {
                showToast('Please enter a kid name', 'error');
                return;
            }
            
            const newKid = {
                id: Date.now().toString(),
                name: name,
                activeMarbles: 0,
                bankMarbles: 0,
                goalLabel: goalLabel,
                goalTarget: goalTarget,
                completedGoals: []
            };
            
            kids.push(newKid);
            saveData();
            
            // Clear form
            document.getElementById('kidName').value = '';
            document.getElementById('goalLabel').value = '';
            document.getElementById('goalTarget').value = '';
            
            renderKidsView();
            renderParentDashboard();
            showToast(`${name} added successfully!`);
        }

        function updateKidGoal(kidId) {
            const kid = kids.find(k => k.id === kidId);
            if (!kid) return;
            
            const newGoalLabel = prompt(`Enter new goal name for ${kid.name}:`, kid.goalLabel);
            if (newGoalLabel === null) return;
            
            const newGoalTarget = prompt(`Enter target marbles for "${newGoalLabel}":`, kid.goalTarget);
            if (newGoalTarget === null) return;
            
            const target = parseInt(newGoalTarget);
            if (isNaN(target) || target <= 0) {
                showToast('Please enter a valid target number', 'error');
                return;
            }
            
            kid.goalLabel = newGoalLabel.trim() || 'My Goal';
            kid.goalTarget = target;
            
            saveData();
            renderKidsView();
            renderParentDashboard();
            showToast(`Goal updated for ${kid.name}`);
        }

        function removeKid(kidId) {
            if (confirm('Are you sure you want to remove this kid? This cannot be undone.')) {
                kids = kids.filter(kid => kid.id !== kidId);
                saveData();
                renderKidsView();
                renderParentDashboard();
                showToast('Kid removed successfully');
            }
        }

        // Marble Management
        function addMarbles() {
            const kidId = document.getElementById('marbleKidSelect').value;
            const amount = parseInt(document.getElementById('marbleAmount').value);
            const reason = document.getElementById('marbleReason').value.trim();
            
            if (!kidId || !amount || amount <= 0 || !reason) {
                showToast('Please fill in all fields with valid values', 'error');
                return;
            }
            
            const kid = kids.find(k => k.id === kidId);
            if (!kid) {
                showToast('Kid not found', 'error');
                return;
            }
            
            kid.activeMarbles += amount;
            
            // Add transaction
            transactions.push({
                timestamp: new Date().toISOString(),
                kidId: kidId,
                type: 'add',
                amount: amount,
                reason: reason,
                details: null
            });
            
            saveData();
            animateMarbleAdd(kidId, amount);
            renderKidsView();
            
            // Clear form
            document.getElementById('marbleAmount').value = '';
            document.getElementById('marbleReason').value = '';
            
            showToast(`Added ${amount} marbles to ${kid.name}`);
        }

        function removeMarbles() {
            const kidId = document.getElementById('marbleKidSelect').value;
            const amount = parseInt(document.getElementById('marbleAmount').value);
            const reason = document.getElementById('marbleReason').value.trim();
            
            if (!kidId || !amount || amount <= 0 || !reason) {
                showToast('Please fill in all fields with valid values', 'error');
                return;
            }
            
            const kid = kids.find(k => k.id === kidId);
            if (!kid) {
                showToast('Kid not found', 'error');
                return;
            }
            
            if (kid.activeMarbles < amount) {
                showToast('Not enough active marbles', 'error');
                return;
            }
            
            kid.activeMarbles -= amount;
            
            // Add transaction
            transactions.push({
                timestamp: new Date().toISOString(),
                kidId: kidId,
                type: 'remove',
                amount: amount,
                reason: reason,
                details: null
            });
            
            saveData();
            animateMarbleRemove(kidId, amount);
            renderKidsView();
            
            // Clear form
            document.getElementById('marbleAmount').value = '';
            document.getElementById('marbleReason').value = '';
            
            showToast(`Removed ${amount} marbles from ${kid.name}`);
        }

        // Banking System
        function saveToBank() {
            const kidId = document.getElementById('bankKidSelect').value;
            const amount = parseInt(document.getElementById('bankAmount').value);
            
            if (!kidId || !amount || amount <= 0) {
                showToast('Please select a kid and enter a valid amount', 'error');
                return;
            }
            
            const kid = kids.find(k => k.id === kidId);
            if (!kid) {
                showToast('Kid not found', 'error');
                return;
            }
            
            if (kid.activeMarbles < amount) {
                showToast('Not enough active marbles to save', 'error');
                return;
            }
            
            kid.activeMarbles -= amount;
            kid.bankMarbles += amount;
            
            // Add transaction
            transactions.push({
                timestamp: new Date().toISOString(),
                kidId: kidId,
                type: 'save',
                amount: amount,
                reason: 'Saved to bank',
                details: null
            });
            
            saveData();
            renderKidsView();
            
            // Clear form
            document.getElementById('bankAmount').value = '';
            
            // Check for goal achievement
            checkGoalAchievement(kid);
            
            showToast(`Saved ${amount} marbles to ${kid.name}'s bank`);
        }

        function withdrawFromBank() {
            const kidId = document.getElementById('bankKidSelect').value;
            const amount = parseInt(document.getElementById('bankAmount').value);
            
            if (!kidId || !amount || amount <= 0) {
                showToast('Please select a kid and enter a valid amount', 'error');
                return;
            }
            
            const kid = kids.find(k => k.id === kidId);
            if (!kid) {
                showToast('Kid not found', 'error');
                return;
            }
            
            if (kid.bankMarbles < amount) {
                showToast('Not enough bank marbles to withdraw', 'error');
                return;
            }
            
            kid.bankMarbles -= amount;
            kid.activeMarbles += amount;
            
            // Add transaction
            transactions.push({
                timestamp: new Date().toISOString(),
                kidId: kidId,
                type: 'withdraw',
                amount: amount,
                reason: 'Withdrawn from bank',
                details: null
            });
            
            saveData();
            renderKidsView();
            
            // Clear form
            document.getElementById('bankAmount').value = '';
            
            showToast(`Withdrew ${amount} marbles from ${kid.name}'s bank`);
        }

        function kidSaveToBank(kidId) {
            const amount = parseInt(document.getElementById(`saveAmount-${kidId}`).value);
            if (!amount || amount <= 0) {
                showToast('Please enter a valid amount', 'error');
                return;
            }
            
            const kid = kids.find(k => k.id === kidId);
            if (!kid || kid.activeMarbles < amount) {
                showToast('Not enough active marbles', 'error');
                return;
            }
            
            kid.activeMarbles -= amount;
            kid.bankMarbles += amount;
            
            transactions.push({
                timestamp: new Date().toISOString(),
                kidId: kidId,
                type: 'save',
                amount: amount,
                reason: 'Self-saved to bank',
                details: null
            });
            
            saveData();
            renderKidsView();
            
            // Clear input
            document.getElementById(`saveAmount-${kidId}`).value = '';
            
            checkGoalAchievement(kid);
            showToast(`Saved ${amount} marbles to bank!`);
        }

        function kidWithdrawFromBank(kidId) {
            const amount = parseInt(document.getElementById(`withdrawAmount-${kidId}`).value);
            if (!amount || amount <= 0) {
                showToast('Please enter a valid amount', 'error');
                return;
            }
            
            const kid = kids.find(k => k.id === kidId);
            if (!kid || kid.bankMarbles < amount) {
                showToast('Not enough bank marbles', 'error');
                return;
            }
            
            kid.bankMarbles -= amount;
            kid.activeMarbles += amount;
            
            transactions.push({
                timestamp: new Date().toISOString(),
                kidId: kidId,
                type: 'withdraw',
                amount: amount,
                reason: 'Self-withdrawn from bank',
                details: null
            });
            
            saveData();
            renderKidsView();
            
            // Clear input
            document.getElementById(`withdrawAmount-${kidId}`).value = '';
            
            showToast(`Withdrew ${amount} marbles from bank!`);
        }

        // Goal Achievement
        function checkGoalAchievement(kid) {
            if (kid.bankMarbles >= kid.goalTarget) {
                // Achievement!
                playConfetti();
                showToast(`🎉 ${kid.name} achieved their goal: ${kid.goalLabel}!`, 'success');
                
                // Record the completed goal
                const completedGoal = {
                    goalName: kid.goalLabel,
                    targetAmount: kid.goalTarget,
                    completedDate: new Date().toISOString(),
                    id: Date.now().toString()
                };
                
                if (!kid.completedGoals) kid.completedGoals = [];
                kid.completedGoals.push(completedGoal);
                
                // Deduct the EXACT goal amount from bank
                kid.bankMarbles -= kid.goalTarget;
                
                // Add achievement transaction
                transactions.push({
                    timestamp: new Date().toISOString(),
                    kidId: kid.id,
                    type: 'achievement',
                    amount: kid.goalTarget,
                    reason: `Goal achieved: ${kid.goalLabel}`,
                    details: completedGoal.id
                });
                
                saveData();
                renderKidsView();
                renderParentDashboard();
                
                // Ask if they want to set a new goal
                setTimeout(() => {
                    if (confirm(`${kid.name} completed "${kid.goalLabel}"! Would you like to set a new goal?`)) {
                        updateKidGoal(kid.id);
                    }
                }, 2000);
            }
        }

        // Chore System
        function awardChore(choreId) {
            const chore = chores.find(c => c.id === choreId);
            if (!chore) return;
            
            // Show kid selector modal (simplified - using prompt for now)
            const kidNames = kids.map(k => k.name);
            if (kidNames.length === 0) {
                showToast('No kids added yet', 'error');
                return;
            }
            
            const selectedKidName = prompt(`Award "${chore.name}" (${chore.marbleValue} marbles) to:\n\n` + kidNames.map((name, i) => `${i + 1}. ${name}`).join('\n') + '\n\nEnter number:');
            
            if (!selectedKidName || isNaN(selectedKidName)) return;
            
            const kidIndex = parseInt(selectedKidName) - 1;
            if (kidIndex < 0 || kidIndex >= kids.length) return;
            
            const kid = kids[kidIndex];
            kid.activeMarbles += chore.marbleValue;
            
            transactions.push({
                timestamp: new Date().toISOString(),
                kidId: kid.id,
                type: 'add',
                amount: chore.marbleValue,
                reason: `Chore completed: ${chore.name}`,
                details: choreId
            });
            
            saveData();
            animateMarbleAdd(kid.id, chore.marbleValue);
            renderKidsView();
            
            showToast(`Awarded ${chore.marbleValue} marbles to ${kid.name} for ${chore.name}`);
        }

        // Rewards System
        function addReward() {
            const name = document.getElementById('newRewardName').value.trim();
            const cost = parseInt(document.getElementById('newRewardCost').value);
            
            if (!name || !cost || cost <= 0) {
                showToast('Please enter valid reward name and cost', 'error');
                return;
            }
            
            const newReward = {
                id: Date.now().toString(),
                name: name,
                cost: cost,
                notes: 'Custom'
            };
            
            rewards.push(newReward);
            saveData();
            renderRewards();
            
            // Clear form
            document.getElementById('newRewardName').value = '';
            document.getElementById('newRewardCost').value = '';
            
            showToast('Reward added successfully!');
        }

        function purchaseReward(rewardId, kidId) {
            const reward = rewards.find(r => r.id === rewardId);
            const kid = kids.find(k => k.id === kidId);
            
            if (!reward || !kid) return;
            
            const totalMarbles = kid.activeMarbles + kid.bankMarbles;
            if (totalMarbles < reward.cost) {
                showToast('Not enough marbles for this reward', 'error');
                return;
            }
            
            if (!confirm(`Purchase "${reward.name}" for ${reward.cost} marbles?`)) {
                return;
            }
            
            // Spend active first, then bank
            let remaining = reward.cost;
            if (kid.activeMarbles >= remaining) {
                kid.activeMarbles -= remaining;
            } else {
                remaining -= kid.activeMarbles;
                kid.activeMarbles = 0;
                kid.bankMarbles -= remaining;
            }
            
            transactions.push({
                timestamp: new Date().toISOString(),
                kidId: kidId,
                type: 'purchase',
                amount: reward.cost,
                reason: `Purchased: ${reward.name}`,
                details: rewardId
            });
            
            saveData();
            renderKidsView();
            renderRewards();
            
            showToast(`${kid.name} purchased ${reward.name}!`);
        }

        // Animations
        function animateMarbleAdd(kidId, count) {
            const jar = document.querySelector(`.marble-jar[data-kid-id="${kidId}"]`);
            if (!jar) return;
            
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const marble = document.createElement('div');
                    marble.className = 'marble';
                    marble.style.backgroundColor = getRandomMarbleColor();
                    marble.style.left = Math.random() * 240 + 'px';
                    marble.style.top = '-20px';
                    
                    jar.appendChild(marble);
                    
                    // Animate drop
                    setTimeout(() => {
                        const existingMarbles = jar.querySelectorAll('.marble').length - 1;
                        const row = Math.floor(existingMarbles / 13);
                        const col = existingMarbles % 13;
                        
                        marble.style.left = (col * 18 + 10) + 'px';
                        marble.style.top = (jar.offsetHeight - 30 - row * 18) + 'px';
                    }, 100);
                    
                }, i * 200);
            }
        }

        function animateMarbleRemove(kidId, count) {
            const jar = document.querySelector(`.marble-jar[data-kid-id="${kidId}"]`);
            if (!jar) return;
            
            const marbles = jar.querySelectorAll('.marble');
            for (let i = 0; i < Math.min(count, marbles.length); i++) {
                setTimeout(() => {
                    const marble = marbles[marbles.length - 1 - i];
                    if (marble) {
                        marble.style.transform = 'translateY(-100px)';
                        marble.style.opacity = '0';
                        setTimeout(() => marble.remove(), 800);
                    }
                }, i * 150);
            }
        }

        function getRandomMarbleColor() {
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3', '#54a0ff', '#5f27cd'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function playConfetti() {
            const container = document.getElementById('confettiContainer');
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3'];
            
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.animationDelay = Math.random() * 2 + 's';
                    
                    container.appendChild(confetti);
                    
                    setTimeout(() => confetti.remove(), 3000);
                }, i * 50);
            }
        }

        // UI Rendering
        function renderKidsView() {
            const container = document.getElementById('kidsGrid');
            container.innerHTML = '';
            
            kids.forEach(kid => {
                const totalMarbles = kid.activeMarbles + kid.bankMarbles;
                const progressPercent = Math.min((kid.bankMarbles / kid.goalTarget) * 100, 100);
                
                const kidCard = document.createElement('div');
                kidCard.className = 'kid-card';
                kidCard.innerHTML = `
                    <div class="kid-name">${kid.name}</div>
                    
                    <div class="marble-jar-container">
                        <div class="marble-jar" data-kid-id="${kid.id}">
                            ${renderMarbles(kid.activeMarbles)}
                        </div>
                    </div>
                    
                    <div class="marble-stats">
                        <div class="stat-box active">
                            <div>Active</div>
                            <div>${kid.activeMarbles}</div>
                        </div>
                        <div class="stat-box bank">
                            <div>Bank</div>
                            <div>${kid.bankMarbles}</div>
                        </div>
                        <div class="stat-box total">
                            <div>Total</div>
                            <div>${totalMarbles}</div>
                        </div>
                        <div class="stat-box">
                            <div>Goal</div>
                            <div>${kid.goalTarget}</div>
                        </div>
                    </div>
                    
                    <div class="goal-section">
                        <div class="goal-name">🎯 ${kid.goalLabel}</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progressPercent}%"></div>
                        </div>
                        <div style="font-size: 12px; color: #666;">
                            ${kid.bankMarbles} / ${kid.goalTarget} marbles saved
                        </div>
                        <button class="btn" onclick="updateKidGoal('${kid.id}')" style="margin-top: 8px; font-size: 12px; padding: 6px 12px;">
                            Edit Goal
                        </button>
                    </div>
                    
                    <div class="bank-controls">
                        <input type="number" id="saveAmount-${kid.id}" placeholder="Amount" min="1" max="${kid.activeMarbles}">
                        <button class="btn" onclick="kidSaveToBank('${kid.id}')">Save to Bank</button>
                    </div>
                    
                    <div class="bank-controls">
                        <input type="number" id="withdrawAmount-${kid.id}" placeholder="Amount" min="1" max="${kid.bankMarbles}">
                        <button class="btn" onclick="kidWithdrawFromBank('${kid.id}')">Withdraw</button>
                    </div>
                `;
                
                container.appendChild(kidCard);
            });
        }

        function renderMarbles(count) {
            let marblesHTML = '';
            for (let i = 0; i < count; i++) {
                const row = Math.floor(i / 13);
                const col = i % 13;
                const color = getRandomMarbleColor();
                marblesHTML += `
                    <div class="marble" style="
                        background-color: ${color};
                        left: ${col * 18 + 10}px;
                        top: ${350 - 30 - row * 18}px;
                    "></div>
                `;
            }
            return marblesHTML;
        }

        function renderParentDashboard() {
            // Update kid selectors
            const kidSelectors = ['marbleKidSelect', 'bankKidSelect'];
            kidSelectors.forEach(selectorId => {
                const select = document.getElementById(selectorId);
                select.innerHTML = '<option value="">Choose a kid...</option>';
                kids.forEach(kid => {
                    select.innerHTML += `<option value="${kid.id}">${kid.name}</option>`;
                });
            });
            
            // Update kids list
            const kidsList = document.getElementById('kidsList');
            kidsList.innerHTML = '';
            kids.forEach(kid => {
                const kidDiv = document.createElement('div');
                kidDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f5f5f5; border-radius: 8px; margin-bottom: 10px;';
                kidDiv.innerHTML = `
                    <div>
                        <strong>${kid.name}</strong><br>
                        <small>Goal: ${kid.goalLabel} (${kid.goalTarget} marbles)</small>
                    </div>
                    <button class="btn danger" onclick="removeKid('${kid.id}')">Remove</button>
                `;
                kidsList.appendChild(kidDiv);
            });
            
            // Update family stats
            const stats = document.getElementById('familyStats');
            const totalActive = kids.reduce((sum, kid) => sum + kid.activeMarbles, 0);
            const totalBank = kids.reduce((sum, kid) => sum + kid.bankMarbles, 0);
            const totalMarbles = totalActive + totalBank;
            
            stats.innerHTML = `
                <div style="display: grid; gap: 15px;">
                    <div class="stat-box">👥 Kids: ${kids.length}</div>
                    <div class="stat-box active">💎 Total Active: ${totalActive}</div>
                    <div class="stat-box bank">🏦 Total Bank: ${totalBank}</div>
                    <div class="stat-box total">🎯 Total Marbles: ${totalMarbles}</div>
                </div>
            `;
            
            // Update completed goals
            const completedGoalsContainer = document.getElementById('completedGoals');
            const allCompletedGoals = kids.flatMap(kid => 
                (kid.completedGoals || []).map(goal => ({
                    ...goal,
                    kidName: kid.name,
                    kidId: kid.id
                }))
            ).sort((a, b) => new Date(b.completedDate) - new Date(a.completedDate));
            
            if (allCompletedGoals.length === 0) {
                completedGoalsContainer.innerHTML = '<p style="color: #666; text-align: center; font-style: italic;">No goals completed yet</p>';
            } else {
                completedGoalsContainer.innerHTML = `
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${allCompletedGoals.map(goal => `
                            <div style="background: #f8f9fa; padding: 12px; margin-bottom: 8px; border-radius: 8px; border-left: 4px solid #ffd700;">
                                <div style="font-weight: bold; color: #333;">${goal.goalName}</div>
                                <div style="font-size: 12px; color: #666; margin-top: 4px;">
                                    ${goal.kidName} • ${goal.targetAmount} marbles • ${new Date(goal.completedDate).toLocaleDateString()}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }

        function renderChores() {
            const container = document.getElementById('choresContainer');
            const categories = ['Morning', 'After School', 'Evening', 'Weekend', 'Extra'];
            
            container.innerHTML = '';
            
            categories.forEach(category => {
                const categoryChores = chores.filter(chore => chore.category === category);
                if (categoryChores.length === 0) return;
                
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'chore-category';
                categoryDiv.innerHTML = `
                    <div class="category-title">${category} (Max ${getCategoryMax(category)})</div>
                    <div class="chore-list">
                        ${categoryChores.map(chore => `
                            <div class="chore-item">
                                <div class="chore-info">
                                    <div class="chore-name">${chore.name}</div>
                                    <div class="chore-value">${chore.marbleValue} marbles${chore.dailyMax ? ` (max ${chore.dailyMax}/day)` : ''}</div>
                                </div>
                                <button class="award-btn" onclick="awardChore('${chore.id}')">Award</button>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                container.appendChild(categoryDiv);
            });
        }

        function getCategoryMax(category) {
            switch(category) {
                case 'Morning': return 4;
                case 'After School': return 7;
                case 'Evening': return 16;
                case 'Weekend': return 'N/A';
                case 'Extra': return 'N/A';
                default: return 'N/A';
            }
        }

        function renderRewards() {
            const container = document.getElementById('rewardsGrid');
            container.innerHTML = '';
            
            rewards.forEach(reward => {
                const rewardCard = document.createElement('div');
                rewardCard.className = 'reward-card';
                
                // Check affordability for each kid
                const affordableKids = kids.filter(kid => (kid.activeMarbles + kid.bankMarbles) >= reward.cost);
                
                rewardCard.innerHTML = `
                    <div class="reward-cost">${reward.cost} marbles</div>
                    <div class="reward-name">${reward.name}</div>
                    <div style="color: #666; font-size: 12px; margin-bottom: 15px;">${reward.notes}</div>
                    ${affordableKids.length > 0 ? `
                        <div style="margin-bottom: 10px; font-weight: bold; color: #4ecdc4;">
                            Available for: ${affordableKids.map(k => k.name).join(', ')}
                        </div>
                        ${affordableKids.map(kid => `
                            <button class="btn success" onclick="purchaseReward('${reward.id}', '${kid.id}')" style="margin: 2px; font-size: 12px; padding: 6px 12px;">
                                ${kid.name}
                            </button>
                        `).join('')}
                    ` : `
                        <div style="color: #999; font-style: italic;">Not affordable yet</div>
                    `}
                `;
                
                container.appendChild(rewardCard);
            });
        }

        function renderHistory() {
            // Update kid filter
            const kidFilter = document.getElementById ('historyKidFilter');
            kidFilter.innerHTML = '<option value="">All Kids</option>';
            kids.forEach(kid => {
                kidFilter.innerHTML += `<option value="${kid.id}">${kid.name}</option>`;
            });
            
            // Filter transactions
            const kidFilter_value = document.getElementById('historyKidFilter').value;
            const typeFilter = document.getElementById('historyTypeFilter').value;
            
            let filteredTransactions = transactions.slice().reverse(); // Most recent first
            
            if (kidFilter_value) {
                filteredTransactions = filteredTransactions.filter(t => t.kidId === kidFilter_value);
            }
            
            if (typeFilter) {
                filteredTransactions = filteredTransactions.filter(t => t.type === typeFilter);
            }
            
            // Render table
            const container = document.getElementById('historyContainer');
            if (filteredTransactions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">No transactions found</p>';
                return;
            }
            
            container.innerHTML = `
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Kid</th>
                            <th>Type</th>
                            <th>Amount</th>
                            <th>Reason</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredTransactions.map(transaction => {
                            const kid = kids.find(k => k.id === transaction.kidId);
                            const date = new Date(transaction.timestamp).toLocaleString();
                            return `
                                <tr>
                                    <td>${date}</td>
                                    <td>${kid ? kid.name : 'Unknown'}</td>
                                    <td>${transaction.type}</td>
                                    <td>${transaction.amount}</td>
                                    <td>${transaction.reason}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        // Utility Functions
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function toggleRules() {
            const content = document.getElementById('rulesContent');
            content.classList.toggle('open');
        }

        function exportHistory() {
            const kidFilter = document.getElementById('historyKidFilter').value;
            const typeFilter = document.getElementById('historyTypeFilter').value;
            
            let filteredTransactions = transactions.slice();
            
            if (kidFilter) {
                filteredTransactions = filteredTransactions.filter(t => t.kidId === kidFilter);
            }
            
            if (typeFilter) {
                filteredTransactions = filteredTransactions.filter(t => t.type === typeFilter);
            }
            
            // Create CSV
            const headers = ['Date', 'Kid', 'Type', 'Amount', 'Reason'];
            const csvContent = [
                headers.join(','),
                ...filteredTransactions.map(transaction => {
                    const kid = kids.find(k => k.id === transaction.kidId);
                    const date = new Date(transaction.timestamp).toLocaleString();
                    return [
                        `"${date}"`,
                        `"${kid ? kid.name : 'Unknown'}"`,
                        `"${transaction.type}"`,
                        transaction.amount,
                        `"${transaction.reason}"`
                    ].join(',');
                })
            ].join('\n');
            
            // Download
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `marble-history-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showToast('History exported successfully!');
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            initializeData();
            addSyncIndicator();
            addManualSyncButton();
            
initializeGitHubSync('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');
            
            renderKidsView();
            renderParentDashboard();
            renderChores();
            renderRewards();
            
            // Add event listeners for filters
            document.getElementById('historyKidFilter').addEventListener('change', renderHistory);
            document.getElementById('historyTypeFilter').addEventListener('change', renderHistory);
            
            // Play intro animation
            setTimeout(() => {
                kids.forEach(kid => {
                    if (kid.activeMarbles > 0) {
                        animateMarbleAdd(kid.id, Math.min(kid.activeMarbles, 10));
                    }
                });
            }, 500);
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case '1':
                        e.preventDefault();
                        switchTab('kids');
                        break;
                    case '2':
                        e.preventDefault();
                        switchTab('parent');
                        break;
                    case '3':
                        e.preventDefault();
                        switchTab('chores');
                        break;
                    case '4':
                        e.preventDefault();
                        switchTab('rewards');
                        break;
                    case '5':
                        e.preventDefault();
                        switchTab('history');
                        break;
                }
            }
        });

        // Auto-save on window close
        window.addEventListener('beforeunload', function() {
            saveData();
        });

        // Periodic auto-save
        setInterval(saveData, 30000); // Save every 30 seconds
    </script>
</body>
</html>
