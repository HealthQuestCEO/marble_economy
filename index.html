<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marble Economy</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
        }

        /* GitHub Setup Section */
        .github-setup {
            background: rgba(255,255,255,0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .github-setup h3 {
            color: #4a5568;
            margin-bottom: 15px;
        }

        .github-setup.hidden {
            display: none;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .nav-tab {
            background: rgba(255,255,255,0.9);
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .nav-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .nav-tab.active {
            background: #ffd700;
            color: #333;
        }

        /* Rules Header */
        .rules-header {
            background: rgba(255,255,255,0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            white-space: pre-wrap;
        }

        .rules-header h3 {
            color: #4a5568;
            margin-bottom: 10px;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Kids View */
        .kids-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin-top: 20px;
        }

        .kid-card {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            transition: transform 0.3s ease;
        }

        .kid-card:hover {
            transform: translateY(-5px);
        }

        .kid-name {
            font-size: 2em;
            color: #4a5568;
            margin-bottom: 20px;
        }

        /* Bell Jar Container */
        .marble-jar {
            position: relative;
            width: 280px;
            height: 350px;
            background: rgba(255,255,255,0.1);
            border: 8px solid #8b4513;
            border-top: none;
            border-radius: 0 0 20px 20px;
            margin: 0 auto;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .marble-jar::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 15px;
            background: #8b4513;
            border-radius: 5px;
        }

        .marble-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            display: flex;
            flex-direction: row; 
            flex-wrap: wrap;   
            align-content: flex-start;
            padding: 10px;
        }

        .marble {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            margin: 2px;
            box-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            transition: transform 0.3s ease;
            position: relative;
        }
        
        .marble.removing {
            animation: marbleRemove 0.8s ease-in forwards;
        }
        
        @keyframes marbleRemove {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-100px) scale(0.5); opacity: 0; }
        }

        .marble-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: #f7fafc;
            padding: 10px;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
        }

        .stat-label {
            font-size: 0.9em;
            color: #718096;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #2d3748;
        }

        .goal-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #fff5cd;
            border-radius: 10px;
            border: 2px solid #ffd700;
        }
        
        .goal-section h4 {
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .goal-progress {
            width: 100%;
            height: 20px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .goal-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #ffd700, #ffed4e);
            transition: width 0.5s ease;
        }
        
        .upcoming-goals, .completed-goals {
            margin-top: 15px;
            text-align: left;
            padding-left: 20px;
        }
        
        .upcoming-goals h5, .completed-goals h5 {
            color: #555;
            margin-bottom: 5px;
            font-size: 1.1em;
        }
        
        .goal-item {
            margin-bottom: 5px;
            color: #777;
        }

        .kid-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f, #a8e6cf);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        /* Parent Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }

        .dashboard-card {
            background: rgba(255,255,255,0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .dashboard-card h3 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #4a5568;
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
        }

        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .goal-reorder-list {
            list-style: none;
        }

        .goal-reorder-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        
        .reorder-buttons button {
            background: none;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
            color: #667eea;
            margin-left: 5px;
        }
        .reorder-buttons button:hover {
            color: #4a5568;
        }

        /* Status indicator */
        .status-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            z-index: 1001;
        }

        .status-online {
            background: #48bb78;
            color: white;
        }

        .status-offline {
            background: #e53e3e;
            color: white;
        }

        .status-syncing {
            background: #ed8936;
            color: white;
        }

        /* Chores & Rewards */
        .category-section {
            margin-bottom: 30px;
            background: rgba(255,255,255,0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .category-title {
            font-size: 1.5em;
            color: #4a5568;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chore-item,
        .reward-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: #f7fafc;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
        }

        .chore-name,
        .reward-name {
            font-weight: bold;
            color: #2d3748;
        }
        
        .chore-details, .reward-details-left {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .marble-value {
            background: #667eea;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
        }

        .reward-cost {
            background: #ffd700;
            color: #333;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
        }
        
        .reward-details {
            text-align: right;
        }
        
        .reward-note {
            font-size: 0.8em;
            color: #718096;
            margin-top: 5px;
            font-weight: normal;
        }

        /* History */
        .history-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: rgba(255,255,255,0.95);
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .transaction-type {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .type-add { background: #c6f6d5; color: #22543d; }
        .type-remove { background: #fed7d7; color: #742a2a; }
        .type-save { background: #fefcbf; color: #744210; }
        .type-withdraw { background: #bee3f8; color: #2a4365; }
        .type-purchase { background: #e9d8fd; color: #44337a; }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Confetti */
        .confetti {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 999;
        }

        .confetti-piece {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #ffd700;
            animation: confettiFall 3s linear infinite;
        }

        @keyframes confettiFall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .kids-grid {
                grid-template-columns: 1fr;
            }
            
            .marble-jar {
                width: 250px;
                height: 300px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .nav-tabs {
                flex-direction: column;
                align-items: center;
            }
        }

        /* Accessibility */
        .btn:focus,
        input:focus,
        select:focus {
            outline: 3px solid #667eea;
            outline-offset: 2px;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</head>
<body>
    <div id="statusIndicator" class="status-indicator status-offline">Offline</div>
    
    <div class="app-container">
        <header class="header">
            <h1>🏺 Marble Economy 🏺</h1>
            <p>Earn, Save, Spend - The Fun Way!</p>
        </header>

        <!-- GitHub Setup Section -->
        <div class="github-setup" id="githubSetup">
            <h3>🔐 Setup Cloud Storage</h3>
            <p>To sync your data across devices, connect to GitHub:</p>
            <div class="input-group">
                <label for="githubToken">GitHub Personal Access Token:</label>
                <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                <small>Create one at: github.com/settings/tokens (needs 'repo' scope)</small>
            </div>
            <div class="input-group">
                <label for="githubRepo">Repository (username/repo-name):</label>
                <input type="text" id="githubRepo" placeholder="yourusername/marble-economy-data">
            </div>
            <button class="btn btn-primary" onclick="setupGitHubStorage()">Connect GitHub</button>
            <button class="btn btn-warning" onclick="useLocalStorage()">Use Local Storage (Demo Mode)</button>
        </div>

        <nav class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('kids')">Kids View</button>
            <button class="nav-tab" onclick="showTab('parent')">Parent Dashboard</button>
            <button class="nav-tab" onclick="showTab('chores')">Chores</button>
            <button class="nav-tab" onclick="showTab('rewards')">Rewards</button>
            <button class="nav-tab" onclick="showTab('history')">History</button>
        </nav>

        <div class="rules-header" id="rulesHeader">
            <h3>📜 House Rules</h3>
            <p id="rulesContent"></p>
        </div>

        <div id="kids" class="tab-content active">
            <div class="kids-grid" id="kidsGrid">
                <!-- Kid cards will be generated here -->
            </div>
        </div>

        <div id="parent" class="tab-content">
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <h3>📊 Family Stats</h3>
                    <div class="stats-overview" id="familyStats">
                        <!-- Family stats will be generated here -->
                    </div>
                </div>

                <div class="dashboard-card">
                    <h3>👤 Manage Kids</h3>
                    <div class="input-group">
                        <label for="kidName">Kid Name:</label>
                        <input type="text" id="kidName" placeholder="Enter name">
                    </div>
                    <div class="input-group">
                        <label for="goalLabel">First Goal Label (optional):</label>
                        <input type="text" id="goalLabel" placeholder="e.g., Camp Champions">
                    </div>
                    <div class="input-group">
                        <label for="goalTarget">First Goal Target:</label>
                        <input type="number" id="goalTarget" placeholder="120" min="1">
                    </div>
                    <div class="input-group">
                        <label for="goalDueDate">First Goal Due Date (optional):</label>
                        <input type="date" id="goalDueDate">
                    </div>
                    <button class="btn btn-primary" onclick="addKid()">Add Kid</button>
                </div>

                <div class="dashboard-card">
                    <h3>🎯 Add New Goal</h3>
                    <div class="input-group">
                        <label for="selectKidGoal">Select Kid:</label>
                        <select id="selectKidGoal"></select>
                    </div>
                    <div class="input-group">
                        <label for="newGoalLabel">New Goal Label:</label>
                        <input type="text" id="newGoalLabel" placeholder="e.g., New Bike">
                    </div>
                    <div class="input-group">
                        <label for="newGoalTarget">New Goal Target:</label>
                        <input type="number" id="newGoalTarget" placeholder="150" min="1">
                    </div>
                    <div class="input-group">
                        <label for="newGoalDueDate">Due Date (optional):</label>
                        <input type="date" id="newGoalDueDate">
                    </div>
                    <button class="btn btn-primary" onclick="addGoal()">Add New Goal</button>
                </div>

                <div class="dashboard-card">
                    <h3>🔄 Reorder Goals</h3>
                    <div class="input-group">
                        <label for="selectKidReorder">Select Kid:</label>
                        <select id="selectKidReorder" onchange="loadGoalsToReorder()"></select>
                    </div>
                    <ul id="goalReorderList" class="goal-reorder-list">
                        <!-- Goals to reorder will be listed here -->
                    </ul>
                </div>

                <div class="dashboard-card">
                    <h3>🏺 Marble Management</h3>
                    <div class="input-group">
                        <label for="selectKidMarbles">Select Kid:</label>
                        <select id="selectKidMarbles">
                            <option value="">Choose a kid...</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="marbleAmount">Marble Amount:</label>
                        <input type="number" id="marbleAmount" min="1" placeholder="5">
                    </div>
                    <div class="input-group">
                        <label for="marbleReason">Reason:</label>
                        <input type="text" id="marbleReason" placeholder="Completed chore">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="addMarbles()">Add Marbles</button>
                        <button class="btn btn-warning" onclick="removeMarbles()">Remove Marbles</button>
                    </div>
                </div>

                <div class="dashboard-card">
                    <h3>☁️ Data Management</h3>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="manualSync()">Sync Now</button>
                        <button class="btn btn-warning" onclick="exportData()">Export Backup</button>
                        <button class="btn btn-warning" onclick="importData()">Import Backup</button>
                    </div>
                    <input type="file" id="importFile" style="display: none;" accept=".json" onchange="handleImport(event)">
                    <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
                        Last sync: <span id="lastSyncTime">Never</span>
                    </p>
                </div>
            </div>
        </div>

        <div id="chores" class="tab-content">
            <div class="category-section">
                <div class="category-title">
                    🌅 Morning Chores (Max 4 per day)
                </div>
                <div id="morningChores"></div>
            </div>

            <div class="category-section">
                <div class="category-title">
                    🎒 After School Chores (Max 7 per day)
                </div>
                <div id="afterSchoolChores"></div>
            </div>

            <div class="category-section">
                <div class="category-title">
                    🌙 Evening Chores (Max 16 per day)
                </div>
                <div id="eveningChores"></div>
            </div>

            <div class="category-section">
                <div class="category-title">
                    🔁 Weekend Jobs
                </div>
                <div id="weekendChores"></div>
            </div>

            <div class="category-section">
                <div class="category-title">
                    🎲 Extra Grab-Bag Jobs
                </div>
                <div id="extraChores"></div>
            </div>
        </div>

        <div id="rewards" class="tab-content">
            <div class="category-section">
                <div class="category-title">
                    🎮 Screen Time (1 hr - M-F) (3 hr Sat-Sun)
                </div>
                <div id="screenTimeRewards"></div>
            </div>

            <div class="category-section">
                <div class="category-title">
                    🏆 Weekly Rewards
                </div>
                <div id="weeklyRewards"></div>
            </div>
        </div>

        <div id="history" class="tab-content">
            <div class="dashboard-card">
                <h3>📜 Transaction History</h3>
                <div class="history-filters">
                    <select id="filterKid">
                        <option value="">All Kids</option>
                    </select>
                    <select id="filterType">
                        <option value="">All Types</option>
                        <option value="add">Add Marbles</option>
                        <option value="remove">Remove Marbles</option>
                        <option value="save">Save to Bank</option>
                        <option value="withdraw">Withdraw from Bank</option>
                        <option value="purchase">Purchase</option>
                    </select>
                    <button class="btn btn-primary" onclick="filterHistory()">Filter</button>
                    <button class="btn btn-primary" onclick="exportHistory()">Export CSV</button>
                </div>
                <div id="historyList"></div>
            </div>
        </div>
    </div>

    <div class="modal" id="confirmModal">
        <div class="modal-content">
            <h3 id="modalTitle">Confirm Action</h3>
            <div id="modalMessage" style="margin: 15px 0;">Are you sure?</div>
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
                <button class="btn btn-primary" id="confirmBtn">Confirm</button>
                <button class="btn btn-warning" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div class="confetti" id="confetti"></div>

    <script>
        // Storage configuration
        let storageConfig = {
            type: 'local', // 'local' or 'github'
            github: {
                token: '',
                repo: '',
                branch: 'main',
                dataFile: 'marble-data.json'
            }
        };

        // Data Storage
        let kids = [];
        let transactions = [];
        let isOnline = false;
        let lastSyncTime = null;
        
        // Default chores and rewards based on your spec
        const rules = `Marbles roll over to next week.
No buying marbles with money.
Optional weekend cash-out: 20 marbles = $1 (max $5).
Feelings are always okay. Only disrespect = marble loss.
Complete all chores for the day  -  1/2 price iPad time.
Devices off 8:30 weekdays, 10:00pm weekends`;
        
        const defaultChores = {
            morning: [
                { name: '🛏 Make bed', value: 1, dailyMax: 1 },
                { name: '🪥 Brush teeth', value: 1, dailyMax: 1 },
                { name: '🎒 Get ready (clothes, shoes, backpack)', value: 1, dailyMax: 1 },
                { name: '🐶 Feed dogs', value: 1, dailyMax: 1 }
            ],
            afterSchool: [
                { name: '🎒 Put away backpack/lunchbox', value: 1, dailyMax: 1 },
                { name: '📚 Homework', value: 2, dailyMax: 1 },
                { name: '✏️ Read/Write/Draw (15 min)', value: 1, dailyMax: 2 },
                { name: '🔬 Math/Science/Coding (15 min)', value: 1, dailyMax: 2 }
            ],
            evening: [
                { name: '🐾 Walk dogs', value: 2, dailyMax: 1 },
                { name: '🐶 Feed dogs', value: 1, dailyMax: 1 },
                { name: '🏀 Sports/Conditioning (15 min)', value: 1, dailyMax: 6 },
                { name: '🍽 Load/Unload dishwasher', value: 2, dailyMax: 1 },
                { name: '🍴 Set/Clear table', value: 1, dailyMax: 1 },
                { name: '🧹 Quick room tidy', value: 1, dailyMax: 1 },
                { name: '🚿 Shower + brush hair', value: 2, dailyMax: 1 },
                { name: '🪥 Brush teeth', value: 1, dailyMax: 1 }
            ],
            weekend: [
                { name: '🐾 Walk dogs AM', value: 2, dailyMax: 1 },
                { name: '🐾 Walk dogs PM', value: 2, dailyMax: 1 },
                { name: '👕 Laundry', value: 3, dailyMax: 1 },
                { name: '💩 Pick up poop', value: 3, dailyMax: 1 },
                { name: '🏊 Clean pool', value: 4, dailyMax: 1 },
                { name: '🛁 Clean bathrooms', value: 4, dailyMax: 1 },
                { name: '👕 Bedroom/Closet', value: 4, dailyMax: 1 }
            ],
            extra: [
                { name: '🗑 Trash gather/out', value: 1, dailyMax: null },
                { name: '🧽 Wipe counters', value: 1, dailyMax: null },
                { name: '🧸 Clean playroom', value: 1, dailyMax: null },
                { name: '👩‍🍳 Help dinner', value: 2, dailyMax: null },
                { name: '🧹 Vacuum House', value: 3, dailyMax: null },
                { name: '🧽 Mop', value: 4, dailyMax: null }
            ]
        };

        const defaultRewards = {
            screenTime: [
                { name: '15 min', cost: 5 },
                { name: '30 min', cost: 10 },
                { name: '45 min', cost: 15 },
                { name: '60 min', cost: 20 },
                { name: '120 min', cost: 40, note: '(Weekend)' },
                { name: '180 min', cost: 60, note: '(Weekend)' }
            ],
            weekly: [
                { name: 'Playdate with friends 🎉', cost: 50 },
                { name: 'Half-Price Weds Playdate', cost: 25, note: 'Half-price' },
                { name: 'Choose weekend activity 🛝⛸️🎳', cost: 75 },
                { name: '$5 cash 💵', cost: 100, note: '(Max/week)'}
            ]
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', init);

        async function init() {
            checkStorageConfig();
            await loadData();
            checkInitialState();
            renderAll();
            updateLastSyncTime();
            
            // Auto-sync every 5 minutes if using GitHub
            if (storageConfig.type === 'github') {
                setInterval(autoSync, 5 * 60 * 1000);
            }
        }
        
        function renderAll() {
            renderKids();
            renderParentDashboard();
            renderChores();
            renderRewards();
            renderHistory();
            document.getElementById('rulesContent').textContent = rules;
        }

        // Storage Management Functions
        function checkStorageConfig() {
            const savedConfig = localStorage.getItem('marbleStorageConfig');
            if (savedConfig) {
                storageConfig = JSON.parse(savedConfig);
                if (storageConfig.type === 'github') {
                    document.getElementById('githubSetup').classList.add('hidden');
                    updateStatus('online');
                }
            }
        }

        function setupGitHubStorage() {
            const token = document.getElementById('githubToken').value.trim();
            const repo = document.getElementById('githubRepo').value.trim();

            if (!token || !repo) {
                showModal('Error', 'Please provide both GitHub token and repository name.', [{ text: 'OK', action: closeModal }]);
                return;
            }

            storageConfig = {
                type: 'github',
                github: {
                    token: token,
                    repo: repo,
                    branch: 'main',
                    dataFile: 'marble-data.json'
                }
            };

            localStorage.setItem('marbleStorageConfig', JSON.stringify(storageConfig));
            document.getElementById('githubSetup').classList.add('hidden');
            init();
        }

        function useLocalStorage() {
            storageConfig.type = 'local';
            localStorage.setItem('marbleStorageConfig', JSON.stringify(storageConfig));
            document.getElementById('githubSetup').classList.add('hidden');
            init();
        }
        
        function checkInitialState() {
             if (storageConfig.type !== 'local' || kids.length > 0) {
                 document.getElementById('githubSetup').classList.add('hidden');
             }
        }

        async function loadData() {
            if (storageConfig.type === 'github') {
                try {
                    updateStatus('syncing');
                    const response = await fetch(`https://api.github.com/repos/${storageConfig.github.repo}/contents/${storageConfig.github.dataFile}`, {
                        headers: { 'Authorization': `token ${storageConfig.github.token}` }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const content = JSON.parse(atob(data.content));
                        kids = content.kids || [];
                        transactions = content.transactions || [];
                        lastSyncTime = new Date().toISOString();
                    } else {
                        // File might not exist, initialize empty
                        kids = [];
                        transactions = [];
                    }
                    updateStatus('online');
                } catch (error) {
                    console.error('GitHub load failed:', error);
                    updateStatus('offline');
                    loadLocalData(); // Fallback to local
                }
            } else {
                loadLocalData();
            }
        }

        function loadLocalData() {
            const localData = localStorage.getItem('marbleData');
            if (localData) {
                const data = JSON.parse(localData);
                kids = data.kids || [];
                transactions = data.transactions || [];
            }
        }

        async function saveData() {
            const data = { kids, transactions };
            if (storageConfig.type === 'github') {
                try {
                    updateStatus('syncing');
                    // First, get the current SHA of the file
                    let sha;
                    const getResponse = await fetch(`https://api.github.com/repos/${storageConfig.github.repo}/contents/${storageConfig.github.dataFile}`, {
                        headers: { 'Authorization': `token ${storageConfig.github.token}` }
                    });
                    if (getResponse.ok) {
                        sha = (await getResponse.json()).sha;
                    }

                    const content = btoa(JSON.stringify(data, null, 2));
                    const body = {
                        message: `Update marble data: ${new Date().toISOString()}`,
                        content: content,
                        sha: sha,
                        branch: storageConfig.github.branch
                    };

                    const response = await fetch(`https://api.github.com/repos/${storageConfig.github.repo}/contents/${storageConfig.github.dataFile}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${storageConfig.github.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(body)
                    });

                    if (!response.ok) throw new Error('Failed to save to GitHub');
                    lastSyncTime = new Date().toISOString();
                    updateStatus('online');
                    updateLastSyncTime();
                } catch (error) {
                    console.error('GitHub save failed:', error);
                    updateStatus('offline');
                    saveLocalData(data); // Save locally as fallback
                }
            } else {
                saveLocalData(data);
            }
        }

        function saveLocalData(data) {
            localStorage.setItem('marbleData', JSON.stringify(data));
        }

        // --- Kid Management ---
        async function addKid() {
            const name = document.getElementById('kidName').value.trim();
            const goalLabel = document.getElementById('goalLabel').value.trim();
            const goalTarget = parseInt(document.getElementById('goalTarget').value, 10);
            const goalDueDate = document.getElementById('goalDueDate').value;

            if (!name || !goalTarget) {
                showModal('Error', 'Kid name and first goal target are required.', [{ text: 'OK', action: closeModal }]);
                return;
            }

            kids.push({
                id: `kid-${Date.now()}`,
                name: name,
                marbles: 0,
                bank: 0,
                goals: [{
                    id: `goal-${Date.now()}`,
                    label: goalLabel || `First Goal`,
                    target: goalTarget,
                    dueDate: goalDueDate || null
                }],
                completedGoals: [],
                goalContribution: 0 // ** NEW: Tracks value of completed goals for progress reset
            });

            await saveData();
            renderAll();
            // Clear fields
            document.getElementById('kidName').value = '';
            document.getElementById('goalLabel').value = '';
            document.getElementById('goalTarget').value = '';
            document.getElementById('goalDueDate').value = '';
        }

        // --- Goal Management ---
        async function addGoal() {
            const kidId = document.getElementById('selectKidGoal').value;
            const label = document.getElementById('newGoalLabel').value.trim();
            const target = parseInt(document.getElementById('newGoalTarget').value, 10);
            const dueDate = document.getElementById('newGoalDueDate').value;
        
            if (!kidId || !label || !target) {
                showModal('Error', 'Please select a kid and fill in all goal details.', [{ text: 'OK', action: closeModal }]);
                return;
            }
        
            const kid = kids.find(k => k.id === kidId);
            kid.goals.push({
                id: `goal-${Date.now()}`,
                label,
                target,
                dueDate
            });
        
            await saveData();
            renderAll();
            document.getElementById('newGoalLabel').value = '';
            document.getElementById('newGoalTarget').value = '';
            document.getElementById('newGoalDueDate').value = '';
        }

        // --- Marble Management ---
        async function addMarbles(kidIdFromChore, amountFromChore, reasonFromChore) {
            const kidId = kidIdFromChore || document.getElementById('selectKidMarbles').value;
            const amount = amountFromChore || parseInt(document.getElementById('marbleAmount').value, 10);
            const reason = reasonFromChore || document.getElementById('marbleReason').value.trim();

            if (!kidId || !amount || !reason) {
                showModal('Error', 'Please select a kid, amount, and reason.', [{ text: 'OK', action: closeModal }]);
                return;
            }

            const kid = kids.find(k => k.id === kidId);
            kid.marbles += amount;
            logTransaction(kidId, 'add', amount, reason);

            await saveData();
            renderAll();
            
            // ** NEW: Check if the new marbles completed a goal **
            await checkGoalProgress(kidId);

            document.getElementById('marbleAmount').value = '';
            document.getElementById('marbleReason').value = '';
        }
        
        async function removeMarbles() {
            const kidId = document.getElementById('selectKidMarbles').value;
            const amount = parseInt(document.getElementById('marbleAmount').value, 10);
            const reason = document.getElementById('marbleReason').value.trim();

            if (!kidId || !amount || !reason) {
                showModal('Error', 'Please select a kid, amount, and reason.', [{ text: 'OK', action: closeModal }]);
                return;
            }

            const kid = kids.find(k => k.id === kidId);
            kid.marbles = Math.max(0, kid.marbles - amount);
            logTransaction(kidId, 'remove', -amount, reason);
            
            await saveData();
            renderAll();
            document.getElementById('marbleAmount').value = '';
            document.getElementById('marbleReason').value = '';
        }

        // ** NEW: Check for goal completion after marbles are added **
        async function checkGoalProgress(kidId) {
            const kid = kids.find(k => k.id === kidId);
            if (!kid || !kid.goals || kid.goals.length === 0) {
                return; // No goals to check
            }

            let goalCompleted = false;
            let totalMarbles = kid.marbles + kid.bank;
            let currentGoal = kid.goals[0];
            
            // Use a loop in case a large marble addition completes multiple goals at once
            while (currentGoal && (totalMarbles - kid.goalContribution) >= currentGoal.target) {
                goalCompleted = true;
                
                // Update goal contribution total
                kid.goalContribution += currentGoal.target;

                // Move goal to completed list
                const completedGoal = kid.goals.shift(); // Remove from upcoming
                completedGoal.dateCompleted = new Date().toISOString();
                if (!kid.completedGoals) kid.completedGoals = [];
                kid.completedGoals.unshift(completedGoal); // Add to front of completed list

                // Trigger confetti for each goal completed
                triggerConfetti();

                // Check for the next goal
                currentGoal = kid.goals.length > 0 ? kid.goals[0] : null;
            }

            if (goalCompleted) {
                // We save and re-render *after* the loop to batch the update
                await saveData();
                renderAll();
                 showModal('Goal Reached!', `🎉 Congratulations, ${kid.name}! You've reached a goal! Keep going! 🎉`, [{ text: 'Awesome!', action: closeModal }]);
            }
        }

        // ** NEW: Handle reward purchases **
        function showPurchaseModal(rewardName, cost) {
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const confirmBtn = document.getElementById('confirmBtn');

            modalTitle.textContent = `Purchase: ${rewardName}`;
            
            let kidsSelectorHTML = `
                <p>This costs ${cost} marbles. Who is buying this?</p>
                <div class="input-group">
                    <label for="purchaseKidSelector">Select Kid:</label>
                    <select id="purchaseKidSelector">
                        ${kids.map(kid => `<option value="${kid.id}">${kid.name} (has ${kid.marbles} active marbles)</option>`).join('')}
                    </select>
                </div>`;
            modalMessage.innerHTML = kidsSelectorHTML;

            confirmBtn.textContent = 'Confirm Purchase';
            confirmBtn.onclick = () => purchaseReward(rewardName, cost);

            document.getElementById('confirmModal').classList.add('active');
        }

        async function purchaseReward(rewardName, cost) {
            const kidId = document.getElementById('purchaseKidSelector').value;
            if (!kidId) return;

            const kid = kids.find(k => k.id === kidId);
            if (kid.marbles < cost) {
                closeModal();
                setTimeout(() => { // Show error after purchase modal closes
                     showModal('Not Enough Marbles!', `${kid.name} doesn't have enough active marbles! You need ${cost} but only have ${kid.marbles}.`, [{text: 'OK', action: closeModal}]);
                }, 100);
                return;
            }

            kid.marbles -= cost;
            logTransaction(kid.id, 'purchase', -cost, `Purchased: ${rewardName}`);
            
            closeModal();
            await saveData();
            renderAll();
        }

        // --- Rendering Functions ---
        function renderKids() {
            const kidsGrid = document.getElementById('kidsGrid');
            kidsGrid.innerHTML = '';
            if (kids.length === 0) {
                kidsGrid.innerHTML = '<p style="color:white; text-align: center; grid-column: 1 / -1;">Add a kid in the Parent Dashboard to get started!</p>';
                return;
            }

            kids.forEach(kid => {
                const totalMarbles = kid.marbles + kid.bank;
                const currentGoal = (kid.goals && kid.goals.length > 0) ? kid.goals[0] : null;

                // ** UPDATED: Calculate progress based on marbles earned since the last goal **
                const goalContribution = kid.goalContribution || 0;
                const progressMarbles = totalMarbles - goalContribution;
                const progressPercent = currentGoal ? Math.min(100, (progressMarbles / currentGoal.target) * 100) : 0;
                
                const card = document.createElement('div');
                card.className = 'kid-card';
                card.innerHTML = `
                    <h2 class="kid-name">${kid.name}</h2>
                    <div class="marble-jar">
                        <div class="marble-container" id="marbles-${kid.id}"></div>
                    </div>
                    <div class="marble-stats">
                        <div class="stat-box">
                            <div class="stat-label">Active</div>
                            <div class="stat-value">${kid.marbles}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Bank</div>
                            <div class="stat-value">${kid.bank}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Total</div>
                            <div class="stat-value">${totalMarbles}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Goal</div>
                            <div class="stat-value">${currentGoal ? currentGoal.target : 'N/A'}</div>
                        </div>
                    </div>
                    
                    ${currentGoal ? `
                    <div class="goal-section">
                        <h4>
                            <span>🏆 ${currentGoal.label}</span>
                            ${currentGoal.dueDate ? `<small>Due: ${currentGoal.dueDate}</small>` : ''}
                        </h4>
                        <p>${progressMarbles} / ${currentGoal.target} marbles (${Math.round(progressPercent)}%)</p>
                        <div class="goal-progress">
                            <div class="goal-progress-bar" style="width: ${progressPercent}%;"></div>
                        </div>
                        ${(kid.goals.length > 1) ? `
                        <div class="upcoming-goals">
                            <h5>Upcoming:</h5>
                            ${kid.goals.slice(1, 3).map(g => `<div class="goal-item">${g.label} (${g.target} marbles)</div>`).join('')}
                        </div>
                        ` : ''}
                        ${(kid.completedGoals && kid.completedGoals.length > 0) ? `
                         <div class="completed-goals">
                            <h5>Completed:</h5>
                             ${kid.completedGoals.slice(0, 2).map(g => `<div class="goal-item">✅ ${g.label} (${g.target} marbles)</div>`).join('')}
                         </div>
                        ` : ''}
                    </div>` : '<div class="goal-section"><p>No active goals. Add one in the Parent Dashboard!</p></div>'}

                    <div class="kid-controls">
                        <input type="number" min="1" placeholder="Amount" id="save-amount-${kid.id}" style="width: 80px; padding: 10px; border-radius: 15px; border: 1px solid #ccc;">
                        <button class="btn btn-primary" onclick="saveMarbles('${kid.id}')">Save</button>
                        <button class="btn btn-warning" onclick="withdrawMarbles('${kid.id}')">Withdraw</button>
                    </div>
                `;
                kidsGrid.appendChild(card);
                renderMarbles(kid);
            });
        }
        
        function renderParentDashboard() {
            // Populate select dropdowns
            const kidSelectors = ['selectKidGoal', 'selectKidReorder', 'selectKidMarbles', 'filterKid'];
            kidSelectors.forEach(id => {
                const select = document.getElementById(id);
                const currentValue = select.value;
                select.innerHTML = (id === 'filterKid' ? '<option value="">All Kids</option>' : '');
                kids.forEach(kid => {
                    select.innerHTML += `<option value="${kid.id}">${kid.name}</option>`;
                });
                if (currentValue) select.value = currentValue;
            });
            
            // Render Family Stats
            const familyStats = document.getElementById('familyStats');
            const totalMarbles = kids.reduce((sum, kid) => sum + kid.marbles + kid.bank, 0);
            const totalBanked = kids.reduce((sum, kid) => sum + kid.bank, 0);
            familyStats.innerHTML = `
                <div class="stat-box">
                    <div class="stat-label">Total Kids</div>
                    <div class="stat-value">${kids.length}</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Total Marbles</div>
                    <div class="stat-value">${totalMarbles}</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Total in Bank</div>
                    <div class="stat-value">${totalBanked}</div>
                </div>
            `;
            loadGoalsToReorder();
        }
        
        function renderRewards() {
            const screenTimeContainer = document.getElementById('screenTimeRewards');
            const weeklyContainer = document.getElementById('weeklyRewards');
            screenTimeContainer.innerHTML = '';
            weeklyContainer.innerHTML = '';

            const createRewardItem = (reward) => `
                <div class="reward-item">
                    <div class="reward-details-left">
                         <span class="reward-name">${reward.name}</span>
                         ${reward.note ? `<span class="reward-note">${reward.note}</span>` : ''}
                    </div>
                    <div class="chore-details">
                        <span class="reward-cost">${reward.cost} marbles</span>
                        <button class="btn btn-success" onclick="showPurchaseModal('${reward.name.replace(/'/g, "\\'")}', ${reward.cost})">Purchase</button>
                    </div>
                </div>
            `;

            defaultRewards.screenTime.forEach(reward => screenTimeContainer.innerHTML += createRewardItem(reward));
            defaultRewards.weekly.forEach(reward => weeklyContainer.innerHTML += createRewardItem(reward));
        }

        // --- Utility & Other Functions ---
        // (Many functions like renderChores, renderHistory, saveMarbles, withdrawMarbles, etc. are unchanged)

        function renderMarbles(kid) {
            const container = document.getElementById(`marbles-${kid.id}`);
            container.innerHTML = '';
            const marbleCount = Math.min(kid.marbles, 200); // Cap at 200 for performance
            for (let i = 0; i < marbleCount; i++) {
                const marble = document.createElement('div');
                marble.className = 'marble';
                const hue = (i * 30) % 360;
                marble.style.background = `radial-gradient(circle at 30% 30%, hsl(${hue}, 80%, 80%), hsl(${hue}, 90%, 50%))`;
                container.appendChild(marble);
            }
        }

        async function saveMarbles(kidId) {
            const amountInput = document.getElementById(`save-amount-${kidId}`);
            const amount = parseInt(amountInput.value, 10);
            if (!amount || amount <= 0) return;

            const kid = kids.find(k => k.id === kidId);
            if (amount > kid.marbles) {
                showModal('Error', 'Not enough active marbles to save.', [{ text: 'OK', action: closeModal }]);
                return;
            }

            kid.marbles -= amount;
            kid.bank += amount;
            logTransaction(kidId, 'save', amount, 'Saved to bank');
            
            await saveData();
            renderAll();
            amountInput.value = '';
        }

        async function withdrawMarbles(kidId) {
            const amountInput = document.getElementById(`save-amount-${kidId}`);
            const amount = parseInt(amountInput.value, 10);
            if (!amount || amount <= 0) return;

            const kid = kids.find(k => k.id === kidId);
            if (amount > kid.bank) {
                showModal('Error', 'Not enough marbles in bank to withdraw.', [{ text: 'OK', action: closeModal }]);
                return;
            }

            kid.bank -= amount;
            kid.marbles += amount;
            logTransaction(kidId, 'withdraw', -amount, 'Withdrew from bank');
            
            await saveData();
            renderAll();
            amountInput.value = '';
        }
        
        function logTransaction(kidId, type, amount, reason) {
            transactions.unshift({
                id: `txn-${Date.now()}`,
                kidId: kidId,
                type: type, // 'add', 'remove', 'save', 'withdraw', 'purchase'
                amount: amount,
                reason: reason,
                date: new Date().toISOString()
            });
            if (transactions.length > 200) { // Keep history manageable
                transactions.pop();
            }
        }
        
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // --- Confetti ---
        function triggerConfetti() {
            const confettiContainer = document.getElementById('confetti');
            confettiContainer.innerHTML = '';
            for (let i = 0; i < 100; i++) {
                const piece = document.createElement('div');
                piece.className = 'confetti-piece';
                piece.style.left = `${Math.random() * 100}vw`;
                piece.style.animationDelay = `${Math.random() * 2}s`;
                const hue = Math.random() * 360;
                piece.style.background = `hsl(${hue}, 100%, 50%)`;
                piece.style.transform = `scale(${Math.random() * 0.5 + 0.5})`;
                confettiContainer.appendChild(piece);
            }
            setTimeout(() => confettiContainer.innerHTML = '', 4000);
        }

        // --- Modal ---
        function showModal(title, message, buttons) {
            document.getElementById('modalTitle').textContent = title;
            const messageDiv = document.getElementById('modalMessage');
            messageDiv.innerHTML = `<p>${message}</p>`;

            const confirmBtn = document.getElementById('confirmBtn');
            const cancelBtn = confirmBtn.nextElementSibling;

            if (buttons && buttons.length > 0) {
                confirmBtn.textContent = buttons[0].text;
                confirmBtn.onclick = buttons[0].action;
                if (buttons.length > 1) {
                    cancelBtn.style.display = 'inline-block';
                    cancelBtn.textContent = buttons[1].text;
                    cancelBtn.onclick = buttons[1].action;
                } else {
                    cancelBtn.style.display = 'none';
                }
            } else {
                 confirmBtn.style.display = 'none';
                 cancelBtn.textContent = "Close";
                 cancelBtn.onclick = closeModal;
            }

            document.getElementById('confirmModal').classList.add('active');
        }


        function closeModal() {
            document.getElementById('confirmModal').classList.remove('active');
        }
        
        function updateStatus(status) {
             const indicator = document.getElementById('statusIndicator');
             indicator.className = 'status-indicator'; // Reset classes
             switch (status) {
                 case 'online':
                     indicator.classList.add('status-online');
                     indicator.textContent = 'Synced';
                     isOnline = true;
                     break;
                 case 'offline':
                     indicator.classList.add('status-offline');
                     indicator.textContent = 'Offline';
                     isOnline = false;
                     break;
                 case 'syncing':
                     indicator.classList.add('status-syncing');
                     indicator.textContent = 'Syncing...';
                     break;
             }
         }

        function updateLastSyncTime() {
            const timeEl = document.getElementById('lastSyncTime');
            if (lastSyncTime && timeEl) {
                timeEl.textContent = new Date(lastSyncTime).toLocaleString();
            }
        }
        
        async function autoSync() {
            if (storageConfig.type === 'github' && navigator.onLine) {
                 await saveData();
            }
        }
        
        async function manualSync() {
            if (storageConfig.type === 'github') {
                await saveData();
                showModal('Sync Complete', 'Data has been saved to GitHub.', [{ text: 'OK', action: closeModal }]);
            } else {
                 showModal('Local Mode', 'You are using local storage. Data is saved automatically in your browser.', [{ text: 'OK', action: closeModal }]);
            }
        }
        
        // Unchanged functions from original file
        function renderChores() {
            const choreContainers = {
                morning: document.getElementById('morningChoores'),
                afterSchool: document.getElementById('afterSchoolChores'),
                evening: document.getElementById('eveningChores'),
                weekend: document.getElementById('weekendChores'),
                extra: document.getElementById('extraChores')
            };

            for (const category in defaultChores) {
                const container = document.getElementById(`${category}Chores`);
                if(container) {
                    container.innerHTML = '';
                    defaultChores[category].forEach(chore => {
                        container.innerHTML += `
                            <div class="chore-item">
                                <span class="chore-name">${chore.name}</span>
                                <div class="chore-details">
                                    <span class="marble-value">+${chore.value} marble${chore.value > 1 ? 's' : ''}</span>
                                    <select onchange="addMarbles(this.value, ${chore.value}, '${chore.name.replace(/'/g, "\\'")}')" class="btn">
                                        <option value="">Give to...</option>
                                        ${kids.map(k => `<option value="${k.id}">${k.name}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                        `;
                    });
                }
            }
        }
        
        function renderHistory() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            transactions.forEach(tx => {
                const kid = kids.find(k => k.id === tx.kidId);
                historyList.innerHTML += `
                    <div class="transaction-item">
                        <div>
                            <strong>${kid ? kid.name : 'Unknown Kid'}</strong>: ${tx.reason}
                            <div style="font-size: 0.8em; color: #666;">${new Date(tx.date).toLocaleString()}</div>
                        </div>
                        <div>
                            <span class="transaction-type type-${tx.type}">${tx.type}</span>
                            <span>${tx.amount > 0 ? '+' : ''}${tx.amount}</span>
                        </div>
                    </div>
                `;
            });
        }
        
        function filterHistory() {
             const kidId = document.getElementById('filterKid').value;
             const type = document.getElementById('filterType').value;
             const historyList = document.getElementById('historyList');
             historyList.innerHTML = '';
             let filtered = transactions;

             if (kidId) {
                 filtered = filtered.filter(tx => tx.kidId === kidId);
             }
             if (type) {
                 filtered = filtered.filter(tx => tx.type === type);
             }
             
             filtered.forEach(tx => {
                const kid = kids.find(k => k.id === tx.kidId);
                historyList.innerHTML += `
                    <div class="transaction-item">
                        <div>
                            <strong>${kid ? kid.name : 'Unknown Kid'}</strong>: ${tx.reason}
                            <div style="font-size: 0.8em; color: #666;">${new Date(tx.date).toLocaleString()}</div>
                        </div>
                        <div>
                            <span class="transaction-type type-${tx.type}">${tx.type}</span>
                            <span>${tx.amount > 0 ? '+' : ''}${tx.amount}</span>
                        </div>
                    </div>
                `;
            });
        }
        
        function exportHistory() {
            let csvContent = "data:text/csv;charset=utf-8,Date,Kid,Type,Amount,Reason\n";
            transactions.forEach(tx => {
                const kid = kids.find(k => k.id === tx.kidId);
                const row = [
                    new Date(tx.date).toISOString(),
                    kid ? kid.name : 'Unknown',
                    tx.type,
                    tx.amount,
                    `"${tx.reason}"`
                ].join(',');
                csvContent += row + "\n";
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "marble_history.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportData() {
            const dataStr = JSON.stringify({ kids, transactions }, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const link = document.createElement('a');
            link.setAttribute('href', dataUri);
            link.setAttribute('download', 'marble-economy-backup.json');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function importData() {
            document.getElementById('importFile').click();
        }
        
        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.kids && data.transactions) {
                        kids = data.kids;
                        transactions = data.transactions;
                        await saveData();
                        renderAll();
                        showModal('Success', 'Data imported successfully!', [{text: 'OK', action: closeModal}]);
                    } else {
                         showModal('Error', 'Invalid backup file format.', [{text: 'OK', action: closeModal}]);
                    }
                } catch (err) {
                     showModal('Error', 'Could not parse backup file.', [{text: 'OK', action: closeModal}]);
                }
            };
            reader.readAsText(file);
        }

        function loadGoalsToReorder() {
            const kidId = document.getElementById('selectKidReorder').value;
            const list = document.getElementById('goalReorderList');
            list.innerHTML = '';
            if (!kidId) return;

            const kid = kids.find(k => k.id === kidId);
            if (!kid || !kid.goals) return;

            kid.goals.forEach((goal, index) => {
                list.innerHTML += `
                    <li class="goal-reorder-item" data-goal-id="${goal.id}">
                        <span>${goal.label} (${goal.target})</span>
                        <div class="reorder-buttons">
                            <button ${index === 0 ? 'disabled' : ''} onclick="moveGoal('${kidId}', ${index}, 'up')">🔼</button>
                            <button ${index === kid.goals.length - 1 ? 'disabled' : ''} onclick="moveGoal('${kidId}', ${index}, 'down')">🔽</button>
                        </div>
                    </li>
                `;
            });
        }

        async function moveGoal(kidId, index, direction) {
            const kid = kids.find(k => k.id === kidId);
            const newIndex = direction === 'up' ? index - 1 : index + 1;
            
            if (newIndex < 0 || newIndex >= kid.goals.length) return;

            // Swap elements
            [kid.goals[index], kid.goals[newIndex]] = [kid.goals[newIndex], kid.goals[index]];

            await saveData();
            renderAll();
        }

    </script>
</body>
</html>
